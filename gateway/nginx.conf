worker_processes auto;
events { worker_connections 1024; }
http {
  include mime.types;
  default_type application/octet-stream;
  sendfile on;
  gzip on;

  # Rate limit simples
  limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;

  # CORS básico (ajuste ALLOWED_ORIGINS no app; aqui liberamos dev local)
  map $http_origin $cors_origin {
    default "";
    ~^https?://(localhost(:\d+)?|127\.0\.0\.1(:\d+)?)$ $http_origin;
  }

  server {
    listen 8080;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
    add_header Access-Control-Allow-Methods "GET,POST,PATCH,PUT,DELETE,OPTIONS" always;
    if ($request_method = OPTIONS) { return 204; }

    # Segurança mínima
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;

    # Auth
    location /auth/ {
      limit_req zone=api burst=20 nodelay;
      proxy_pass http://auth:8081/;
    }

    # Documents
    location /documents/ {
      limit_req zone=api burst=50 nodelay;
      proxy_pass http://documents:8083/;
    }

    # Limits
    location /limits/ {
      limit_req zone=api burst=50 nodelay;
      proxy_pass http://limits:8087/;
    }

    # Orchestrator
    location /orchestrator/ {
      limit_req zone=api burst=50 nodelay;
      proxy_pass http://orchestrator:8085/;
    }

    # Billing
    location /billing/ {
      limit_req zone=api burst=30 nodelay;
      proxy_pass http://billing:8086/;
    }
  }
}
